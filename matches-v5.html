<!DOCTYPE html>
<html lang="en">
<head>
    <script src="config.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Match Details v5 - Optimized Test</title>
    <style>
        /* ============================================================================ */
        /* BASE STYLES */
        /* ============================================================================ */
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }

        /* ============================================================================ */
        /* HEADER */
        /* ============================================================================ */
        
        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 1rem 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            width: 50px;
            height: 50px;
            background: rgba(255,255,255,0.2);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .version-badge {
            background: rgba(255,255,255,0.2);
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-left: 1rem;
        }

        /* ============================================================================ */
        /* LOADING SYSTEM STYLES (Enhanced from roster-v2.html) */
        /* ============================================================================ */
        
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 3rem 1rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            margin: 2rem auto;
            max-width: 500px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .loading-header {
            margin-bottom: 2rem;
        }

        .loading-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            animation: bounce 1.5s ease-in-out infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .loading-title {
            font-size: 1.5rem;
            margin: 0;
            color: #1e3c72;
        }

        .progress-container {
            width: 100%;
            max-width: 300px;
            margin-bottom: 2rem;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 0.5rem;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #1e3c72, #2a5298);
            border-radius: 4px;
            transition: width 0.3s ease;
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .progress-fill.progress-complete {
            background: linear-gradient(90deg, #28a745, #20c997);
        }

        .progress-percentage {
            font-size: 0.875rem;
            font-weight: 600;
            color: #1e3c72;
        }

        .loading-stage {
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: #333;
        }

        .loading-subtext {
            font-size: 0.875rem;
            color: #666;
            margin-bottom: 1.5rem;
        }

        .loading-stats {
            display: flex;
            gap: 2rem;
            font-size: 0.75rem;
            color: #999;
        }

        .loading-complete {
            animation: successPulse 0.6s ease-out;
        }

        @keyframes successPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* Component loading states */
        .component-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            flex-direction: column;
            gap: 1rem;
            color: #666;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #1e3c72;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-state {
            opacity: 0.7;
            pointer-events: none;
            position: relative;
        }

        .loading-error {
            text-align: center;
            padding: 2rem;
            color: #dc3545;
            background: #f8d7da;
            border-radius: 8px;
            border: 1px solid #f5c6cb;
        }

        /* Skeleton loading for lists */
        .skeleton-item {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 4px;
            height: 20px;
            margin: 0.5rem 0;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* ============================================================================ */
        /* MATCH CARDS */
        /* ============================================================================ */

        .match-card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            position: relative;
            transition: all 0.3s ease;
        }

        .match-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }

        .cache-indicator {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: #28a745;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            z-index: 10;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .match-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
        }

        .match-title {
            font-size: 1.75rem;
            color: #1e3c72;
            margin-bottom: 0.5rem;
        }

        .match-subtitle {
            color: #666;
            font-size: 1rem;
        }

        .match-badge {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .match-badge.home {
            background: #d4edda;
            color: #155724;
        }

        .match-badge.away {
            background: #f8d7da;
            color: #721c24;
        }

        .match-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .detail-item {
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #1e3c72;
        }

        .detail-label {
            font-size: 0.75rem;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 0.25rem;
        }

        .detail-value {
            font-weight: 600;
            color: #333;
        }

        /* ============================================================================ */
        /* AVAILABILITY SUMMARY */
        /* ============================================================================ */

        .availability-summary {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin: 2rem 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            position: relative;
        }

        .availability-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1.5rem;
            margin: 1.5rem 0;
        }

        .availability-stat {
            text-align: center;
            padding: 1.5rem;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .availability-stat:hover {
            transform: translateY(-2px);
        }

        .availability-stat.available {
            background: #d4edda;
            border: 2px solid #28a745;
        }

        .availability-stat.unavailable {
            background: #f8d7da;
            border: 2px solid #dc3545;
        }

        .availability-stat.pending {
            background: #fff3cd;
            border: 2px solid #ffc107;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .stat-number.available { color: #28a745; }
        .stat-number.unavailable { color: #dc3545; }
        .stat-number.pending { color: #ffc107; }

        .stat-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #666;
        }

        /* ============================================================================ */
        /* BUTTONS & ACTIONS */
        /* ============================================================================ */

        .actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.875rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-primary {
            background: #1e3c72;
            color: white;
        }

        .btn-primary:hover {
            background: #2a5298;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(30, 60, 114, 0.3);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-large {
            padding: 1rem 2rem;
            font-size: 1rem;
        }

        /* ============================================================================ */
        /* MODAL SYSTEM */
        /* ============================================================================ */

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
            animation: modalFadeIn 0.3s ease-out;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 100%;
            max-width: 700px;
            max-height: 90vh;
            overflow: hidden;
            position: relative;
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-20px) scale(0.95); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }

        .modal-header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 1.5rem;
            position: relative;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.25rem;
        }

        .close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(255,255,255,0.2);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            font-size: 1.25rem;
            transition: all 0.2s;
        }

        .close-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        .modal-body {
            padding: 1.5rem;
            max-height: calc(90vh - 120px);
            overflow-y: auto;
        }

        /* ============================================================================ */
        /* PERFORMANCE INDICATORS */
        /* ============================================================================ */

        .performance-panel {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1rem 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .perf-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .perf-stat {
            text-align: center;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .perf-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e3c72;
        }

        .perf-label {
            font-size: 0.75rem;
            color: #666;
            text-transform: uppercase;
        }

        .cache-status {
            background: #e3f2fd;
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
            font-size: 0.875rem;
            border-left: 4px solid #1565c0;
        }

        /* ============================================================================ */
        /* TEST CONTROLS */
        /* ============================================================================ */

        .test-panel {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 2rem 0;
        }

        .test-title {
            color: #856404;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        /* ============================================================================ */
        /* PLAYER SELECTION */
        /* ============================================================================ */

        .player-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            margin: 1rem 0;
        }

        .player-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border-bottom: 1px solid #f8f9fa;
            transition: background 0.2s;
        }

        .player-item:hover {
            background: #f8f9fa;
        }

        .player-item:last-child {
            border-bottom: none;
        }

        .player-checkbox {
            margin-right: 0.75rem;
        }

        .player-info {
            flex: 1;
        }

        .player-name {
            font-weight: 500;
            color: #333;
        }

        .player-meta {
            font-size: 0.75rem;
            color: #666;
            margin-top: 0.25rem;
        }

        .auto-selected {
            background: #e8f5e8;
        }

        /* ============================================================================ */
        /* RESPONSIVE DESIGN */
        /* ============================================================================ */

        @media (max-width: 768px) {
            .container {
                padding: 0.5rem;
            }

            .match-card {
                padding: 1.5rem;
            }

            .header-content {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .match-details {
                grid-template-columns: 1fr;
            }

            .availability-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 0.5rem;
            }

            .actions-grid {
                grid-template-columns: 1fr;
            }

            .loading-container {
                margin: 1rem;
                padding: 2rem 1rem;
            }

            .modal-content {
                margin: 0.5rem;
                max-height: 95vh;
            }

            .modal-body {
                padding: 1rem;
            }
        }

        /* ============================================================================ */
        /* SUCCESS/ERROR MESSAGES */
        /* ============================================================================ */

        .success-message, .error-message {
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
            font-weight: 500;
            animation: slideDown 0.3s ease-out;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div class="logo-section">
                <div class="logo">üèâ</div>
                <div>
                    <h1>Match Details</h1>
                    <p style="font-size: 0.875rem; opacity: 0.9;">
                        Clontarf Rugby Team Management
                        <span class="version-badge">v5.0 - Optimized</span>
                    </p>
                </div>
            </div>
            <div style="display: flex; gap: 1rem;">
                <a href="matches-v4.html" class="btn btn-secondary" style="color: white; text-decoration: none;">‚Üê Back to Matches</a>
                <a href="roster-v2.html" class="btn btn-secondary" style="color: white; text-decoration: none;">View Roster</a>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Performance Test Panel -->
        <div class="test-panel">
            <div class="test-title">
                üß™ Optimization Test Panel
            </div>
            <p style="margin-bottom: 1rem; color: #856404;">
                This version demonstrates performance optimizations: parallel API calls, caching, and progressive loading.
            </p>
            <div class="test-grid">
                <button class="btn btn-warning" onclick="runPerformanceTest()">
                    ‚ö° Run Speed Test
                </button>
                <button class="btn btn-secondary" onclick="clearAllCaches()">
                    üóëÔ∏è Clear Cache
                </button>
                <button class="btn btn-secondary" onclick="toggleDebugMode()">
                    üîç Toggle Debug
                </button>
                <button class="btn btn-secondary" onclick="showCacheDetails()">
                    üìä Cache Stats
                </button>
            </div>
        </div>

        <!-- Performance Stats -->
        <div class="performance-panel" id="performanceStats" style="display: none;">
            <h3 style="margin-bottom: 1rem;">Performance Metrics</h3>
            <div class="perf-stats" id="perfStatsContainer">
                <!-- Will be populated with performance data -->
            </div>
        </div>

        <!-- Cache Status -->
        <div class="cache-status" id="cacheStatus">
            <strong>Cache Status:</strong> Initializing...
        </div>

        <!-- Messages -->
        <div id="successMessage" style="display: none;" class="success-message"></div>
        <div id="errorMessage" style="display: none;" class="error-message"></div>

        <!-- Match Details Card -->
        <div class="match-card" id="matchDetailsContainer">
            <!-- Will be populated by loadMatchDetailsOptimized() -->
        </div>

        <!-- Availability Summary -->
        <div class="availability-summary" id="availabilitySummary">
            <!-- Will be populated with availability data -->
        </div>

        <!-- Actions Grid -->
        <div class="actions-grid">
            <button class="btn btn-primary btn-large" onclick="openOptimizedAvailabilityModal('M002')">
                üìß Send Availability Request (Optimized)
            </button>
            <button class="btn btn-primary btn-large" onclick="openStandardAvailabilityModal('M002')">
                üìß Send Availability Request (Standard)
            </button>
            <button class="btn btn-success btn-large" onclick="refreshAllData()">
                üîÑ Refresh All Data
            </button>
        </div>
    </div>

    <!-- Optimized Availability Modal -->
    <div class="modal" id="availabilityModal">
        <div class="modal-content">
            <div class="modal-header">
                <button class="close-btn" onclick="closeAvailabilityModal()">&times;</button>
                <h3>Send Availability Request</h3>
                <div style="font-size: 0.875rem; opacity: 0.9; margin-top: 0.5rem;">
                    Optimized with parallel loading and caching
                </div>
            </div>
            <div class="modal-body" id="availabilityModalContent">
                <!-- Will be populated by modal loading functions -->
            </div>
        </div>
    </div>

    <!-- Standard (Slow) Modal for Comparison -->
    <div class="modal" id="standardModal">
        <div class="modal-content">
            <div class="modal-header">
                <button class="close-btn" onclick="closeStandardModal()">&times;</button>
                <h3>Send Availability Request (Standard)</h3>
                <div style="font-size: 0.875rem; opacity: 0.9; margin-top: 0.5rem;">
                    Original sequential loading for comparison
                </div>
            </div>
            <div class="modal-body" id="standardModalContent">
                <!-- Will be populated by standard loading -->
            </div>
        </div>
    </div>

    <script>
        // ============================================================================
        // CONFIGURATION & INITIALIZATION
        // ============================================================================
        
        let WEB_APP_URL;
        let DEBUG_MODE = false;
        let performanceData = {
            loadTimes: [],
            cacheHits: 0,
            cacheMisses: 0
        };

        // Global cache variables
        let playerCache = {
            data: null,
            timestamp: null,
            duration: 5 * 60 * 1000 // 5 minutes
        };
        
        let availabilityCache = new Map();
        const AVAILABILITY_CACHE_DURATION = 2 * 60 * 1000; // 2 minutes

        // Wait for CONFIG to load
        function initializeApp() {
            if (typeof CONFIG === 'undefined') {
                console.log('‚è≥ Waiting for CONFIG...');
                setTimeout(initializeApp, 100);
                return;
            }
            
            WEB_APP_URL = CONFIG.WEB_APP_URL;
            DEBUG_MODE = CONFIG.DEBUG_MODE || false;
            
            console.log('‚úÖ matches-v5.html initialized with optimizations');
            console.log('üîß Config:', { WEB_APP_URL, DEBUG_MODE });
            
            // Start the optimized loading process
            startOptimizedApp();
        }

        async function startOptimizedApp() {
            // Pre-load player cache immediately in background
            getCachedPlayers().then(() => {
                console.log('üöÄ Player cache pre-loaded');
                updateCacheStatus();
            });
            
            // Load match details with optimizations
            await loadMatchDetailsOptimized('M002');
            
            // Update UI
            updateCacheStatus();
            updatePerformanceStats();
        }

        // ============================================================================
        // CORE API FUNCTIONS (Your Working CORS Solution)
        // ============================================================================
        
        async function fetchData(action, params = {}) {
            if (!WEB_APP_URL) {
                throw new Error('WEB_APP_URL not initialized');
            }
            
            const startTime = Date.now();
            const url = new URL(WEB_APP_URL);
            url.searchParams.append('action', action);
            
            Object.keys(params).forEach(key => {
                if (params[key] !== null && params[key] !== undefined) {
                    url.searchParams.append(key, params[key]);
                }
            });

            try {
                if (DEBUG_MODE) {
                    console.log('üîÑ API Request:', action, params);
                }
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                const loadTime = Date.now() - startTime;
                
                // Track performance
                performanceData.loadTimes.push({ action, time: loadTime, timestamp: Date.now() });
                
                if (DEBUG_MODE) {
                    console.log(`‚úÖ API Response (${loadTime}ms):`, action, result);
                }
                
                return result;
            } catch (error) {
                const loadTime = Date.now() - startTime;
                console.error(`‚ùå API Error (${loadTime}ms):`, action, error);
                throw error;
            }
        }

        // ============================================================================
        // SMART CACHING FUNCTIONS
        // ============================================================================

        async function getCachedPlayers(forceRefresh = false) {
            const now = Date.now();
            const isExpired = !playerCache.timestamp || (now - playerCache.timestamp) > playerCache.duration;
            
            if (forceRefresh || !playerCache.data || isExpired) {
                console.log('üîÑ Refreshing player cache...');
                performanceData.cacheMisses++;
                const result = await fetchData('getAllPlayers');
                if (result.success) {
                    playerCache.data = result.data;
                    playerCache.timestamp = now;
                    console.log(`‚úÖ Cached ${result.data.length} players`);
                }
                return result;
            } else {
                console.log('‚ö° Using cached players (instant!)');
                performanceData.cacheHits++;
                return { success: true, data: playerCache.data };
            }
        }

        async function getCachedAvailability(matchId, forceRefresh = false) {
            const cacheKey = `availability_${matchId}`;
            const cached = availabilityCache.get(cacheKey);
            const now = Date.now();
            
            if (forceRefresh || !cached || (now - cached.timestamp) > AVAILABILITY_CACHE_DURATION) {
                console.log(`üîÑ Refreshing availability cache for ${matchId}...`);
                performanceData.cacheMisses++;
                const result = await fetchData('getMatchAvailability', { matchId });
                availabilityCache.set(cacheKey, {
                    data: result,
                    timestamp: now
                });
                return result;
            } else {
                console.log(`‚ö° Using cached availability for ${matchId} (instant!)`);
                performanceData.cacheHits++;
                return cached.data;
            }
        }

        // ============================================================================
        // PROGRESSIVE LOADING SYSTEM
        // ============================================================================

        function createLoadingIndicator(containerId, stages, options = {}) {
            const container = document.getElementById(containerId);
            if (!container) {
                console.error(`Container ${containerId} not found for loading indicator`);
                return null;
            }
            
            const loadingHTML = `
                <div class="loading-container" id="${containerId}_loader">
                    <div class="loading-header">
                        <div class="loading-icon">${options.icon || 'üèâ'}</div>
                        <h3 class="loading-title">${options.title || 'Loading...'}</h3>
                    </div>
                    
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" id="${containerId}_progress" style="width: 0%"></div>
                        </div>
                        <div class="progress-percentage" id="${containerId}_percentage">0%</div>
                    </div>
                    
                    <div class="loading-stage" id="${containerId}_stage">Starting...</div>
                    <div class="loading-subtext" id="${containerId}_subtext">${options.subtext || ''}</div>
                    
                    <div class="loading-stats">
                        <span id="${containerId}_timer">Elapsed: 0s</span>
                        <span id="${containerId}_step">Step 1 of ${stages.length}</span>
                    </div>
                </div>
            `;
            
            container.innerHTML = loadingHTML;
            
            // Start timer
            const startTime = Date.now();
            const timer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const timerEl = document.getElementById(`${containerId}_timer`);
                if (timerEl) timerEl.textContent = `Elapsed: ${elapsed}s`;
            }, 100);
            
            return {
                updateProgress: (stepIndex) => updateLoadingProgress(containerId, stages, stepIndex),
                complete: () => completeLoading(containerId, timer),
                error: (message) => showLoadingError(containerId, message, timer)
            };
        }

        function updateLoadingProgress(containerId, stages, stepIndex) {
            if (stepIndex >= stages.length) return;
            
            const stage = stages[stepIndex];
            
            const progressFill = document.getElementById(`${containerId}_progress`);
            const progressPercentage = document.getElementById(`${containerId}_percentage`);
            const stageEl = document.getElementById(`${containerId}_stage`);
            const stepEl = document.getElementById(`${containerId}_step`);
            
            if (progressFill && progressPercentage) {
                progressFill.style.width = stage.progress + '%';
                progressPercentage.textContent = stage.progress + '%';
                
                if (stage.progress === 100) {
                    progressFill.classList.add('progress-complete');
                }
            }
            
            if (stageEl) stageEl.textContent = stage.text;
            if (stepEl) stepEl.textContent = `Step ${stepIndex + 1} of ${stages.length}`;
        }

        function completeLoading(containerId, timer) {
            clearInterval(timer);
            const loader = document.getElementById(`${containerId}_loader`);
            if (loader) {
                loader.classList.add('loading-complete');
                loader.style.opacity = '0';
                loader.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    if (loader.parentNode) {
                        loader.remove();
                    }
                }, 300);
            }
        }

        function showLoadingError(containerId, message, timer) {
            clearInterval(timer);
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = `
                    <div class="loading-error">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
                        <div style="font-weight: 600; margin-bottom: 0.5rem;">Loading Failed</div>
                        <div style="margin-bottom: 1rem;">${message}</div>
                        <button class="btn btn-primary" onclick="location.reload()">Reload Page</button>
                        <button class="btn btn-secondary" onclick="clearAllCaches()" style="margin-left: 0.5rem;">Clear Cache & Retry</button>
                    </div>
                `;
            }
        }

        // ============================================================================
        // OPTIMIZED MATCH LOADING (PARALLEL API CALLS)
        // ============================================================================

        async function loadMatchDetailsOptimized(matchId) {
            console.log(`üöÄ Loading match details for ${matchId} with optimizations`);
            
            const stages = [
                { text: "Loading match details...", progress: 25 },
                { text: "Fetching availability data...", progress: 50 },
                { text: "Loading match history...", progress: 75 },
                { text: "Complete!", progress: 100 }
            ];
            
            const loader = createLoadingIndicator('matchDetailsContainer', stages, {
                title: 'Loading Match Details',
                icon: 'üèâ',
                subtext: 'Using parallel API calls and caching'
            });
            
            if (!loader) return;
            
            const startTime = Date.now();
            
            try {
                // Step 1: Load basic match data first
                loader.updateProgress(0);
                const matchData = await fetchData('getMatch', { matchId });
                
                if (!matchData.success) {
                    throw new Error('Match not found: ' + matchData.error);
                }
                
                // Step 2 & 3: Load availability and history in PARALLEL (SPEED BOOST!)
                loader.updateProgress(1);
                
                const [availabilityResult, historyResult] = await Promise.all([
                    getCachedAvailability(matchId),
                    fetchData('getMatchHistory', { opponent: matchData.opponent })
                ]);
                
                loader.updateProgress(2);
                
                // Step 4: Display all data
                displayMatchDetails(matchData);
                displayAvailabilitySummary(availabilityResult);
                
                const totalTime = Date.now() - startTime;
                console.log(`‚úÖ Match details loaded in ${totalTime}ms`);
                
                loader.updateProgress(3);
                setTimeout(() => loader.complete(), 300);
                
                // Update performance tracking
                updatePerformanceStats();
                
            } catch (error) {
                console.error('‚ùå Error loading match details:', error);
                loader.error('Failed to load match details: ' + error.message);
            }
        }

        // ============================================================================
        // OPTIMIZED AVAILABILITY MODAL
        // ============================================================================

        async function openOptimizedAvailabilityModal(matchId) {
            console.log(`üöÄ Opening OPTIMIZED availability modal for ${matchId}`);
            
            const modal = document.getElementById('availabilityModal');
            modal.classList.add('active');
            
            const stages = [
                { text: "Preparing player selection...", progress: 20 },
                { text: "Loading squad roster...", progress: 40 },
                { text: "Checking availability status...", progress: 70 },
                { text: "Generating email content...", progress: 90 },
                { text: "Ready to send!", progress: 100 }
            ];
            
            const loader = createLoadingIndicator('availabilityModalContent', stages, {
                title: 'Preparing Availability Request',
                icon: 'üìß',
                subtext: 'Using cached data and parallel loading'
            });
            
            const startTime = Date.now();
            
            try {
                loader.updateProgress(0);
                
                // PARALLEL LOADING - This is the key optimization!
                loader.updateProgress(1);
                
                const [matchResult, playersResult, cachedPlayers] = await Promise.all([
                    fetchData('getMatch', { matchId }),
                    fetchData('getPlayersForSelectionModal', { matchId }),
                    getCachedPlayers() // Lightning fast if cached!
                ]);
                
                loader.updateProgress(2);
                
                if (!matchResult.success) {
                    throw new Error('Match not found');
                }
                
                if (!playersResult.success) {
                    throw new Error('Could not load players: ' + playersResult.error);
                }
                
                loader.updateProgress(3);
                
                // Fast local processing
                const match = matchResult;
                const players = playersResult.players || [];
                const emailContent = generateEmailContent(match);
                const autoSelectedCount = players.filter(p => p.autoSelected).length;
                
                loader.updateProgress(4);
                
                // Render the complete modal
                renderAvailabilityModal(match, players, emailContent, autoSelectedCount);
                
                const totalTime = Date.now() - startTime;
                console.log(`‚úÖ Optimized modal loaded in ${totalTime}ms`);
                
                setTimeout(() => loader.complete(), 200);
                
            } catch (error) {
                console.error('‚ùå Error loading optimized modal:', error);
                loader.error('Failed to load availability request: ' + error.message);
            }
        }

        // Standard (slow) modal for comparison
        async function openStandardAvailabilityModal(matchId) {
            console.log(`üêå Opening STANDARD (slow) availability modal for ${matchId}`);
            
            const modal = document.getElementById('standardModal');
            modal.classList.add('active');
            
            const container = document.getElementById('standardModalContent');
            container.innerHTML = '<div class="component-loading"><div class="loading-spinner"></div><div>Loading without optimizations...</div></div>';
            
            const startTime = Date.now();
            
            try {
                // Sequential loading (the old way)
                console.log('Step 1: Loading match...');
                const matchResult = await fetchData('getMatch', { matchId });
                
                console.log('Step 2: Loading players...');
                const playersResult = await fetchData('getPlayersForSelectionModal', { matchId });
                
                console.log('Step 3: Loading availability...');
                const availabilityResult = await fetchData('getMatchAvailability', { matchId });
                
                const totalTime = Date.now() - startTime;
                console.log(`üêå Standard modal loaded in ${totalTime}ms`);
                
                if (matchResult.success && playersResult.success) {
                    const match = matchResult;
                    const players = playersResult.players || [];
                    const autoSelectedCount = players.filter(p => p.autoSelected).length;
                    
                    container.innerHTML = `
                        <h4>Standard Loading Complete</h4>
                        <p><strong>Load Time:</strong> ${totalTime}ms (Sequential)</p>
                        <p><strong>Match:</strong> ${match.squad} vs ${match.opponent}</p>
                        <p><strong>Players:</strong> ${players.length} (${autoSelectedCount} auto-selected)</p>
                        <div style="margin-top: 1rem;">
                            <button class="btn btn-primary" onclick="sendAvailabilityRequest('${matchId}')">
                                üìß Send Request
                            </button>
                        </div>
                    `;
                }
                
            } catch (error) {
                const totalTime = Date.now() - startTime;
                container.innerHTML = `
                    <div class="loading-error">
                        <div>Standard loading failed after ${totalTime}ms</div>
                        <div>${error.message}</div>
                    </div>
                `;
            }
        }

        // ============================================================================
        // DISPLAY FUNCTIONS
        // ============================================================================

        function displayMatchDetails(matchData) {
            const container = document.getElementById('matchDetailsContainer');
            const isHomeMatch = matchData.homeAway && matchData.homeAway.toLowerCase() === 'home';
            
            container.innerHTML = `
                <div class="cache-indicator">‚ö° Optimized</div>
                <div class="match-header">
                    <div>
                        <h2 class="match-title">${matchData.squad} vs ${matchData.opponent}</h2>
                        <div class="match-subtitle">Match ID: ${matchData.matchId}</div>
                    </div>
                    <div class="match-badge ${isHomeMatch ? 'home' : 'away'}">
                        ${matchData.homeAway.toUpperCase()} MATCH
                    </div>
                </div>
                
                <div class="match-details">
                    <div class="detail-item">
                        <div class="detail-label">Date & Time</div>
                        <div class="detail-value">${matchData.date} at ${matchData.time || 'TBC'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Venue</div>
                        <div class="detail-value">${matchData.location}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Match Type</div>
                        <div class="detail-value">${matchData.matchType}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Status</div>
                        <div class="detail-value">${matchData.status || 'Created'}</div>
                    </div>
                </div>
            `;
        }

        function displayAvailabilitySummary(availabilityData) {
            const container = document.getElementById('availabilitySummary');
            
            if (!availabilityData || !availabilityData.success) {
                container.innerHTML = `
                    <h3>Availability Summary</h3>
                    <div class="loading-error">Error loading availability: ${availabilityData?.error || 'Unknown error'}</div>
                `;
                return;
            }
            
            const summary = availabilityData.summary;
            const isCached = performanceData.cacheHits > performanceData.cacheMisses;
            
            container.innerHTML = `
                <div class="cache-indicator">${isCached ? '‚ö° Cached' : 'üîÑ Fresh'}</div>
                <h3>Availability Summary</h3>
                <div class="availability-grid">
                    <div class="availability-stat available">
                        <div class="stat-number available">${summary.available}</div>
                        <div class="stat-label">Available</div>
                    </div>
                    <div class="availability-stat unavailable">
                        <div class="stat-number unavailable">${summary.unavailable}</div>
                        <div class="stat-label">Unavailable</div>
                    </div>
                    <div class="availability-stat pending">
                        <div class="stat-number pending">${summary.pending}</div>
                        <div class="stat-label">No Response</div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 1rem; font-size: 0.875rem; color: #666;">
                    Total responses: ${summary.total} players
                </div>
            `;
        }

        function generateEmailContent(match) {
            const isHome = match.homeAway && match.homeAway.toLowerCase() === 'home';
            return `
                <h4>${match.squad} vs ${match.opponent}</h4>
                <p><strong>üìÖ Date:</strong> ${match.date} at ${match.time || 'TBC'}</p>
                <p><strong>üìç Venue:</strong> ${match.location} (${match.homeAway})</p>
                <p><strong>üèâ Type:</strong> ${match.matchType}</p>
                ${!isHome ? '<p><strong>üöó Transport:</strong> Please confirm your travel arrangements</p>' : ''}
            `;
        }

        function renderAvailabilityModal(match, players, emailContent, autoSelectedCount) {
            const container = document.getElementById('availabilityModalContent');
            
            container.innerHTML = `
                <div class="cache-indicator">‚ö° Parallel Loaded</div>
                
                <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <h4 style="margin-bottom: 1rem;">üìß Availability Request Ready</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div><strong>Match:</strong> ${match.opponent}</div>
                        <div><strong>Squad:</strong> ${match.squad}</div>
                        <div><strong>Players Found:</strong> ${players.length}</div>
                        <div><strong>Auto-Selected:</strong> ${autoSelectedCount}</div>
                    </div>
                </div>
                
                <div style="margin: 1rem 0;">
                    <h5>Email Content Preview:</h5>
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 6px; font-size: 0.875rem; border: 1px solid #e9ecef;">
                        ${emailContent}
                    </div>
                </div>
                
                <div class="player-list">
                    ${players.slice(0, 5).map(player => `
                        <div class="player-item ${player.autoSelected ? 'auto-selected' : ''}">
                            <input type="checkbox" class="player-checkbox" ${player.autoSelected ? 'checked' : ''}>
                            <div class="player-info">
                                <div class="player-name">${player.name}</div>
                                <div class="player-meta">${player.email} ‚Ä¢ ${player.status} ‚Ä¢ ${player.squadTags}</div>
                            </div>
                        </div>
                    `).join('')}
                    ${players.length > 5 ? `<div style="text-align: center; padding: 1rem; color: #666;">... and ${players.length - 5} more players</div>` : ''}
                </div>
                
                <div style="text-align: center; margin-top: 1.5rem;">
                    <button class="btn btn-primary btn-large" onclick="sendAvailabilityRequest('${match.matchId}')">
                        üìß Send to ${autoSelectedCount} Players
                    </button>
                    <button class="btn btn-secondary" onclick="closeAvailabilityModal()" style="margin-left: 1rem;">
                        Cancel
                    </button>
                </div>
            `;
        }

        // ============================================================================
        // PERFORMANCE TESTING & MONITORING
        // ============================================================================

        async function runPerformanceTest() {
            showMessage('üß™ Running performance test...', 'info');
            
            const testResults = {
                optimizedLoad: 0,
                cachedLoad: 0,
                parallelLoad: 0
            };
            
            try {
                // Test 1: Optimized load (first time)
                console.log('üß™ Test 1: Optimized load (first time)');
                clearAllCaches();
                const start1 = Date.now();
                await loadMatchDetailsOptimized('M002');
                testResults.optimizedLoad = Date.now() - start1;
                
                // Test 2: Cached load (second time)
                console.log('üß™ Test 2: Cached load (repeat)');
                const start2 = Date.now();
                await loadMatchDetailsOptimized('M002');
                testResults.cachedLoad = Date.now() - start2;
                
                // Test 3: Parallel modal load
                console.log('üß™ Test 3: Parallel modal load');
                const start3 = Date.now();
                await simulateModalLoad('M002');
                testResults.parallelLoad = Date.now() - start3;
                
                // Display results
                displayTestResults(testResults);
                
            } catch (error) {
                showMessage('‚ùå Performance test failed: ' + error.message, 'error');
            }
        }

        async function simulateModalLoad(matchId) {
            // Simulate the modal loading without showing UI
            const [matchResult, playersResult, cachedPlayers] = await Promise.all([
                fetchData('getMatch', { matchId }),
                fetchData('getPlayersForSelectionModal', { matchId }),
                getCachedPlayers()
            ]);
            return { matchResult, playersResult, cachedPlayers };
        }

        function displayTestResults(results) {
            const perfPanel = document.getElementById('performanceStats');
            perfPanel.style.display = 'block';
            
            const container = document.getElementById('perfStatsContainer');
            container.innerHTML = `
                <div class="perf-stat">
                    <div class="perf-number">${results.optimizedLoad}ms</div>
                    <div class="perf-label">First Load (Optimized)</div>
                </div>
                <div class="perf-stat">
                    <div class="perf-number">${results.cachedLoad}ms</div>
                    <div class="perf-label">Cached Load</div>
                </div>
                <div class="perf-stat">
                    <div class="perf-number">${results.parallelLoad}ms</div>
                    <div class="perf-label">Parallel Modal</div>
                </div>
                <div class="perf-stat">
                    <div class="perf-number">${Math.round((1 - results.cachedLoad / results.optimizedLoad) * 100)}%</div>
                    <div class="perf-label">Speed Improvement</div>
                </div>
            `;
            
            showMessage(`‚úÖ Performance test complete! Cached loads are ${Math.round((1 - results.cachedLoad / results.optimizedLoad) * 100)}% faster`, 'success');
        }

        function updatePerformanceStats() {
            const recentLoads = performanceData.loadTimes.slice(-10);
            const avgLoadTime = recentLoads.length > 0 ? 
                Math.round(recentLoads.reduce((sum, load) => sum + load.time, 0) / recentLoads.length) : 0;
            
            const container = document.getElementById('perfStatsContainer');
            if (container) {
                container.innerHTML = `
                    <div class="perf-stat">
                        <div class="perf-number">${avgLoadTime}ms</div>
                        <div class="perf-label">Avg Load Time</div>
                    </div>
                    <div class="perf-stat">
                        <div class="perf-number">${performanceData.cacheHits}</div>
                        <div class="perf-label">Cache Hits</div>
                    </div>
                    <div class="perf-stat">
                        <div class="perf-number">${performanceData.cacheMisses}</div>
                        <div class="perf-label">Cache Misses</div>
                    </div>
                    <div class="perf-stat">
                        <div class="perf-number">${performanceData.loadTimes.length}</div>
                        <div class="perf-label">Total API Calls</div>
                    </div>
                `;
            }
        }

        // ============================================================================
        // CACHE MANAGEMENT
        // ============================================================================

        function updateCacheStatus() {
            const statusEl = document.getElementById('cacheStatus');
            if (!statusEl) return;
            
            const playerCacheAge = playerCache.timestamp ? 
                Math.floor((Date.now() - playerCache.timestamp) / 1000) : null;
            
            const cacheHitRate = performanceData.cacheHits + performanceData.cacheMisses > 0 ?
                Math.round((performanceData.cacheHits / (performanceData.cacheHits + performanceData.cacheMisses)) * 100) : 0;
            
            statusEl.innerHTML = `
                <strong>Cache Status:</strong>
                Players: ${playerCache.data ? 
                    `${playerCache.data.length} cached (${playerCacheAge}s old)` : 
                    'Not cached'} |
                Availability: ${availabilityCache.size} matches cached |
                Hit Rate: ${cacheHitRate}% (${performanceData.cacheHits}/${performanceData.cacheHits + performanceData.cacheMisses})
            `;
        }

        function clearAllCaches() {
            playerCache.data = null;
            playerCache.timestamp = null;
            availabilityCache.clear();
            performanceData.cacheHits = 0;
            performanceData.cacheMisses = 0;
            updateCacheStatus();
            console.log('üóëÔ∏è All caches cleared');
            showMessage('Cache cleared! Next load will fetch fresh data.', 'info');
        }

        function showCacheDetails() {
            const details = {
                playerCache: {
                    exists: !!playerCache.data,
                    age: playerCache.timestamp ? Math.floor((Date.now() - playerCache.timestamp) / 1000) : null,
                    playerCount: playerCache.data?.length || 0,
                    sizeEstimate: playerCache.data ? JSON.stringify(playerCache.data).length : 0
                },
                availabilityCache: {
                    entries: availabilityCache.size,
                    keys: Array.from(availabilityCache.keys())
                },
                performance: {
                    totalCalls: performanceData.loadTimes.length,
                    cacheHits: performanceData.cacheHits,
                    cacheMisses: performanceData.cacheMisses,
                    hitRate: performanceData.cacheHits + performanceData.cacheMisses > 0 ?
                        Math.round((performanceData.cacheHits / (performanceData.cacheHits + performanceData.cacheMisses)) * 100) : 0
                }
            };
            
            alert(`üìä Cache Details:\n\nPlayer Cache:\n- ${details.playerCache.playerCount} players cached\n- ${details.playerCache.age}s old\n- ~${Math.round(details.playerCache.sizeEstimate/1024)}KB\n\nAvailability Cache:\n- ${details.availabilityCache.entries} matches\n- Keys: ${details.availabilityCache.keys.join(', ')}\n\nPerformance:\n- ${details.performance.totalCalls} total API calls\n- ${details.performance.hitRate}% cache hit rate\n- ${details.performance.cacheHits} hits, ${details.performance.cacheMisses} misses`);
        }

        // ============================================================================
        // UTILITY FUNCTIONS
        // ============================================================================

        function showMessage(message, type = 'info') {
            hideMessages();
            
            let element;
            if (type === 'success') {
                element = document.getElementById('successMessage');
            } else if (type === 'error') {
                element = document.getElementById('errorMessage');
            } else {
                // For info messages, use success styling
                element = document.getElementById('successMessage');
            }
            
            if (element) {
                element.textContent = message;
                element.style.display = 'block';
                setTimeout(hideMessages, 4000);
            }
        }

        function hideMessages() {
            document.getElementById('successMessage').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
        }

        function toggleDebugMode() {
            DEBUG_MODE = !DEBUG_MODE;
            console.log('üîç Debug mode:', DEBUG_MODE ? 'ON' : 'OFF');
            showMessage(`Debug mode ${DEBUG_MODE ? 'enabled' : 'disabled'}`, 'info');
        }

        async function refreshAllData() {
            showMessage('üîÑ Refreshing all data...', 'info');
            
            // Force refresh of all caches
            await getCachedPlayers(true);
            await getCachedAvailability('M002', true);
            
            // Reload match details
            await loadMatchDetailsOptimized('M002');
            
            updateCacheStatus();
            showMessage('‚úÖ All data refreshed successfully!', 'success');
        }

        // ============================================================================
        // MODAL CONTROLS
        // ============================================================================

        function closeAvailabilityModal() {
            document.getElementById('availabilityModal').classList.remove('active');
        }

        function closeStandardModal() {
            document.getElementById('standardModal').classList.remove('active');
        }

        async function sendAvailabilityRequest(matchId) {
            const modalContent = document.getElementById('availabilityModalContent');
            const originalContent = modalContent.innerHTML;
            
            modalContent.innerHTML = `
                <div class="component-loading">
                    <div class="loading-spinner"></div>
                    <div>Sending availability request...</div>
                </div>
            `;
            
            try {
                const result = await fetchData('sendMatchSpecificAvailabilityRequest', { 
                    matchId: matchId,
                    testMode: true,
                    testEmail: 'luketeeling@gmail.com',
                    testPlayerName: 'Luke Teeling (TEST)'
                });
                
                if (result.success) {
                    modalContent.innerHTML = `
                        <div style="text-align: center; padding: 2rem;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">‚úÖ</div>
                            <h4>Test Email Sent Successfully!</h4>
                            <p>Check ${result.testEmail} for the availability request.</p>
                            <div style="margin-top: 1.5rem;">
                                <button class="btn btn-primary" onclick="closeAvailabilityModal()">Done</button>
                            </div>
                        </div>
                    `;
                    
                    // Refresh availability data in background
                    getCachedAvailability(matchId, true);
                    
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                modalContent.innerHTML = `
                    <div class="loading-error">
                        <div>‚ùå Error sending request</div>
                        <div>${error.message}</div>
                        <button class="btn btn-primary" onclick="closeAvailabilityModal()" style="margin-top: 1rem;">Close</button>
                    </div>
                `;
            }
        }

        // ============================================================================
        // INITIALIZATION
        // ============================================================================

        window.addEventListener('load', function() {
            console.log('üöÄ matches-v5.html loading with optimizations...');
            initializeApp();
        });

        // Also try immediate initialization if DOM ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeAvailabilityModal();
                closeStandardModal();
            }
            
            // Debug shortcuts
            if (e.key === 'r' && e.ctrlKey) {
                e.preventDefault();
                refreshAllData();
            }
            
            if (e.key === 'c' && e.ctrlKey && e.shiftKey) {
                e.preventDefault();
                clearAllCaches();
            }
        });

        // Update cache status every 10 seconds
        setInterval(updateCacheStatus, 10000);

        // Performance monitoring
        window.addEventListener('beforeunload', function() {
            const sessionStats = {
                totalLoadTime: performanceData.loadTimes.reduce((sum, load) => sum + load.time, 0),
                apiCalls: performanceData.loadTimes.length,
                cacheEfficiency: performanceData.cacheHits / (performanceData.cacheHits + performanceData.cacheMisses) * 100,
                avgLoadTime: performanceData.loadTimes.length > 0 ? 
                    performanceData.loadTimes.reduce((sum, load) => sum + load.time, 0) / performanceData.loadTimes.length : 0
            };
            console.log('üìä Session Performance Summary:', sessionStats);
        });
    </script>
</body>
</html>
